<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ZaidGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="shortcut icon" href="./assets/images/zaideee.png" type="image/png" />

  <!-- MAIN SITE CSS (same as homepage) -->
  <link rel="stylesheet" href="./css/master.css" />

  <!-- UV + preload (optional but consistent) -->
  <script src="/uv/uv.bundle.js" charset="UTF-8"></script>
  <script src="/uv/uv.config.js"></script>
  <script src="./js/preload.js"></script>
</head>

<body theme="main">

  <!-- NAVBAR (SAME AS MAIN SITE) -->
  <nav>
    <div class="logo">
      <img src="./assets/images/zaideee.png" alt="Logo" draggable="false" />
      <h1>zaids proxy</h1>
      <h3>ZaidGPT</h3>
    </div>

    <p id="time"></p>

    <div class="navitems">
      <div class="navitem"><a href="/">Home</a></div>
      <div class="navitem"><a href="/gs.html">Games</a></div>
      <div class="navitem"><a href="/apps.html">Apps</a></div>
      <div class="navitem"><a href="/emulator.html">Emulator</a></div>
      <div class="navitem"><a selected href="/zaidgpt.html">ZaidGPT</a></div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="center-container" style="max-width: 900px;">
    <h1>Zaid<span>GPT</span></h1>
    <h3>Chat with ZaidGPT</h3>

    <!-- CHAT BOX -->
    <div
      id="messages"
      style="
        height: 55vh;
        overflow-y: auto;
        padding: 20px;
        border-radius: 10px;
        background: rgba(0,0,0,0.4);
        margin: 20px 0;
      "
    >
      <p style="opacity: 0.7;">Start a conversation…</p>
    </div>

    <!-- INPUT -->
    <input
      id="input"
      type="text"
      placeholder="Type your message…"
      onkeydown="handleKey(event)"
      style="width: 80%;"
    />
    <br /><br />

    <button onclick="sendMessage()" class="button play">Send</button>
    <button onclick="launchab()" class="button play">Panic</button>
  </div>

  <!-- FOOTER LINKS (SAME STYLE) -->
  <div class="links">
    <div class="left">
      <a href="/">Home</a>
      <a href="/gs.html">Games</a>
      <a href="/apps.html">Apps</a>
    </div>
    <div class="right">
      <a href="./settings.html">Settings</a>
    </div>
  </div>

<script>
/* ===============================
   THEME + PANIC (SITE STANDARD)
   =============================== */

if (localStorage.getItem('theme')) {
  document.body.setAttribute('theme', localStorage.getItem('theme'))
}

if (localStorage.getItem('launchblank') && window.self !== window.top) {
  launchab()
}

function launchab() {
  const tab = window.open('about:blank', '_blank')
  if (!tab) return
  const iframe = tab.document.createElement('iframe')
  const stl = iframe.style
  stl.border = stl.outline = 'none'
  stl.width = '100vw'
  stl.height = '100vh'
  stl.position = 'fixed'
  stl.left = stl.right = stl.top = stl.bottom = '0'
  iframe.src = self.location
  tab.document.body.appendChild(iframe)
  window.parent.window.location.replace(
    localStorage.getItem('panicurl') || 'https://classroom.google.com/h'
  )
}

document.addEventListener('keydown', (e) => {
  if (
    localStorage.getItem('panickey') &&
    localStorage.getItem('panickey') === e.key
  ) {
    window.parent.window.location.replace(
      localStorage.getItem('panicurl') || 'https://classroom.google.com/h'
    )
  }
})

/* ===============================
   CHAT LOGIC
   =============================== */

let messages = []
const messagesDiv = document.getElementById('messages')
const input = document.getElementById('input')

function handleKey(e) {
  if (e.key === 'Enter') sendMessage()
}

function renderMessages() {
  messagesDiv.innerHTML = ''
  messages.forEach(m => {
    const p = document.createElement('p')
    p.style.textAlign = m.role === 'user' ? 'right' : 'left'
    p.style.margin = '10px 0'
    p.innerHTML = `<strong>${m.role === 'user' ? 'You' : 'ZaidGPT'}:</strong> ${m.content}`
    messagesDiv.appendChild(p)
  })
  messagesDiv.scrollTop = messagesDiv.scrollHeight
}

async function sendMessage() {
  const text = input.value.trim()
  if (!text) return

  messages.push({ role: 'user', content: text })
  input.value = ''
  renderMessages()

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages })
    })
    const data = await res.json()
    messages.push({
      role: 'assistant',
      content: data.reply || 'No response.'
    })
    renderMessages()
  } catch (err) {
    messages.push({
      role: 'assistant',
      content: 'Error contacting server.'
    })
    renderMessages()
  }
}
</script>

<script src="./js/index.js"></script>
</body>
</html>
